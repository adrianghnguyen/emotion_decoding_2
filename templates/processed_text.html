{% extends "base.html" %}
{% block title %} Processed entry {% endblock %}
{% block content %}
<!-- Original user input-->
<div class="container" id="text_input">
	<p id="inputText" >{{ input_text }}</p>
</div>
<!-- Machine-learning model results-->
<div class="container border border-secondary rounded mb-3" id="chart_displays" >
	<h3 class="py-3">Machine-learning detected results</h3>
	<div class="row">
		      <div class="col-sm" id="custom-container">
          <canvas id="radarEmotionCategories"></canvas>
      </div>
      <div class="col-sm" id="custom-container">
          <canvas id="detailedRadar"></canvas>
      </div>
	</div>
	<!-- Results printout -->
	<div class="container my-3" id="raw_results_output">
	    <ul>
	        {% for result in emotion_results %}
	            {% if result.get("filter") == True %}
	                <li>
	                    {{ result.get("emotion")|capitalize }} ({{ result.get("definition")}}) presence detected with a score of
	                    <b>{{result.get("score")|round(2)}}</b>
	                </li>
	            {% endif %}
	        {% endfor %}
	    </ul>
	    All values <b><{{ filtering_threshold }} </b> have been filtered.
	</div>
</div>
<script>
	function saveResult(){
        <!-- Write in submitted values to local storage. Keep as local script to pass in results -->
        document.addEventListener('DOMContentLoaded', function()
        {
            let key_name = new Date().getTime();
            let input_text = document.getElementById('inputText').innerText;
            let emotion_results = {{ emotion_results|tojson }};
            let timestamp = new Date().toISOString();
            
            let jsonObject = {
                keyName: key_name,
                emotionResults: emotion_results,
                inputText: input_text,
                timestamp: timestamp
            };
    
        // Storing data in localStorage
        try {
            let jsonString = JSON.stringify(jsonObject);
            localStorage.setItem(key_name, jsonString);
            
            // Success message
            console.log("Wrote submission entry to local storage");
            console.log(jsonObject)
            renderCharts() // Callback function
        } catch (error) {
            // Error message if storing fails
            console.error("Failed to save submission to local storage", error);
        }
        });
	}

    function renderCharts(){
        latest_emotion_result = retrieveLatestEmotionObject() //Executes after writing in the value?
        radarDetailed(latest_emotion_result, 'detailedRadar')
        radarEmotionCategories(latest_emotion_result, 'radarEmotionCategories')
    }

saveResult()
</script>
{% endblock %}
